#!/usr/bin/env bash
set -euo pipefail

repo_root="$(git rev-parse --show-toplevel)"
cd "$repo_root"

if ! command -v clang-format >/dev/null 2>&1; then
    echo "pre-commit: clang-format not found in PATH."
    exit 1
fi

shopt -s globstar nullglob
files=(src/**/*.cpp src/**/*.h tests/**/*.cpp tests/**/*.h)
if (( ${#files[@]} )); then
    clang-format -i -- "${files[@]}"
fi

# Optional (slow): build + test before commit.
if [[ "${HB_PRECOMMIT_RUN_TESTS:-0}" == "1" ]]; then
    preset="${HB_PRECOMMIT_CMAKE_PRESET:-ninja-multi-vcpkg}"
    cmake --build --preset "$preset"
    ctest --preset "$preset"
fi
